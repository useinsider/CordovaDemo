name: Check Pull Request

on:
  pull_request:
    branches:
      - develop
      - master
      - release/*
      - epic/*
      - feature/*
      - bug/*
      - hotfix/*
    types:
      - opened
      - edited
      - synchronize

jobs:
  check-pull-request:
    name: Check Pull Request
    runs-on: self-runner-node
    permissions:
      contents: read
      pull-requests: write
    env:
      COMMIT_RULES: >
        [
          {"label":"security", "regex":"\\((?:security)\\)"}
        ]
      BRANCH_RULES: >
        {
          "epic/": "epic",
          "release/": "release",
          "bug/": "bug"
        }
    steps:
      - name: Create GitHub App token
        id: github-app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.InsiderActionsApplication_APP_ID }}
          private-key: ${{ secrets.InsiderActionsApplication_PRIVATE_KEY }}

      - name: Update Assignee to Author
        uses: actions/github-script@v8
        if: ${{ github.event.pull_request.user.login != 'insideractionsapplication[bot]' && github.event.pull_request.user.login != 'insideractionsapplication' }}
        with:
          github-token: ${{ steps.github-app-token.outputs.token }}
          script: |
            const owner = context.repo.owner;
            const repository = context.repo.repo;
            const pullRequest = context.payload.pull_request;
            const author = pullRequest.user.login;

            await github.rest.issues.addAssignees({
              owner: owner,
              repo: repository,
              issue_number: pullRequest.number,
              assignees: [author]
            });

      - name: Update Labels
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.github-app-token.outputs.token }}
          script: |
            const owner = context.repo.owner;
            const repository = context.repo.repo;
            const pullRequest = context.payload.pull_request;
            const branch = pullRequest.head.ref;

            const branchRules = JSON.parse(process.env.BRANCH_RULES || "{}");
            const commitRules = JSON.parse(process.env.COMMIT_RULES || "[]")
              .map(r => ({ ...r, regex: new RegExp(r.regex, "i") }));

            const labelsToAdd = new Set();
            for (const [prefix, label] of Object.entries(branchRules)) {
              if (branch.startsWith(prefix)) {
                labelsToAdd.add(label);
              }
            }
            const commits = await github.paginate(
              github.rest.pulls.listCommits,
              { owner: owner, repo: repository, pull_number: pullRequest.number }
            );            
            for (const rule of commitRules) {
              const hit = commits.some(c => rule.regex.test(c.commit.message));
              if (hit) labelsToAdd.add(rule.label);
            }
            if (labelsToAdd.size > 0) {
              await github.rest.issues.addLabels({
                owner: owner, 
                repo: repository,
                issue_number: pullRequest.number,
                labels: Array.from(labelsToAdd)
              });
            }

      - name: Check Title
        id: check
        if: ${{ !startsWith(github.head_ref, 'release/') }}
        continue-on-error: true
        uses: thehanimo/pr-title-checker@v1.4.3
        with:
          GITHUB_TOKEN: ${{ steps.github-app-token.outputs.token }}
          configuration_path: .github/pr-title-checker-config.json
          pass_on_octokit_error: false

      - name: Add Comment (PR Title Needs Formatting)
        uses: marocchino/sticky-pull-request-comment@v2.9.4
        if: ${{ steps.check.outputs.success == 'false' }}
        continue-on-error: true
        with:
          GITHUB_TOKEN: ${{ steps.github-app-token.outputs.token }}
          header: 'PR Title Check'
          hide_and_recreate: true
          hide_classify: "OUTDATED"
          message: |
            ### ðŸš¨ PR Title Needs Formatting
            The PR title should contain a corresponding JIRA ID.
            Please update the title to match the format `MOB-[0-9]+ ...`.
            Example: `MOB-1234 - Add feature X`

      - name: Add Comment (PR Title is Correct)
        if: ${{ steps.check.outputs.success == 'true' }}
        uses: marocchino/sticky-pull-request-comment@v2.9.4
        continue-on-error: true
        with:
          GITHUB_TOKEN: ${{ steps.github-app-token.outputs.token }}
          header: 'PR Title Check'
          hide_and_recreate: true
          hide_classify: "OUTDATED"
          message: |
            ### âœ… PR Title Correctly Formatted
            The PR title is in correct format. Thank you! ðŸŽ‰

      - name: Fail Job (PR Title Needs Formatting)
        if: ${{ steps.check.outputs.success == 'false' }}
        run: |
            echo "::error title=PR Title Check::PR title must start with MOB-<number> (e.g., MOB-24511)"
            exit 1
